version: 0.2

env:
  variables:
    IMAGE_REPO_NAME: devcloud-ecr
    IMAGE_TAG: latest
    AWS_REGION: sa-east-1
    CLUSTER_NAME: devcloud-cluster
    SERVICE_NAME: devcloud-service
    TASK_FAMILY: devcloud-task

  privileged: true

phases:
  pre_build:
    commands:
      - echo "ğŸ” Fazendo login no Amazon ECR..."
      - $(aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin 136508419156.dkr.ecr.$AWS_REGION.amazonaws.com)
      - export REPOSITORY_URI="136508419156.dkr.ecr.$AWS_REGION.amazonaws.com/$IMAGE_REPO_NAME"
      - echo "ğŸ“¦ URI do repositÃ³rio: $REPOSITORY_URI"

  build:
    commands:
      - echo "ğŸ”§ Construindo a imagem Docker..."
      - docker build -t $IMAGE_REPO_NAME .
      - docker tag $IMAGE_REPO_NAME:$IMAGE_TAG $REPOSITORY_URI:$IMAGE_TAG

  post_build:
    commands:
      - echo "ğŸ“¤ Enviando a imagem para o ECR..."
      - docker push $REPOSITORY_URI:$IMAGE_TAG
      - echo "ğŸ“„ Obtendo definiÃ§Ã£o de tarefa atual..."
      - TASK_DEFINITION_JSON=$(aws ecs describe-task-definition --task-definition $TASK_FAMILY)
      - echo "ğŸ› ï¸ Criando nova definiÃ§Ã£o com a nova imagem..."
      - NEW_TASK_DEF=$(echo $TASK_DEFINITION_JSON | jq --arg IMAGE "$REPOSITORY_URI:$IMAGE_TAG" '.taskDefinition | {family, executionRoleArn, networkMode, containerDefinitions, requiresCompatibilities, cpu, memory} | .containerDefinitions[0].image = $IMAGE')
      - echo "ğŸ’¾ Salvando a nova task definition em arquivo temporÃ¡rio..."
      - echo "$NEW_TASK_DEF" > new-task-def.json
      - echo "ğŸ“ Registrando a nova revisÃ£o da task definition..."
      - TASK_REVISION=$(aws ecs register-task-definition --cli-input-json file://new-task-def.json | jq -r '.taskDefinition.taskDefinitionArn')
      - echo "ğŸš€ Atualizando o serviÃ§o ECS com a nova task..."
      - aws ecs update-service --cluster $CLUSTER_NAME --service $SERVICE_NAME --task-definition $TASK_REVISION
      - echo "âœ… Deploy finalizado com sucesso!"

artifacts:
  files: []
